name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize]
    branches:
      - main

permissions:
  contents: read
  pull-requests: write

jobs:
  ai-review:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install requests
      
      - name: Get PR diff
        id: get-diff
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get the diff between the base and head branches
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          
          # Generate the diff
          git diff $BASE_SHA..$HEAD_SHA > pr_diff.txt
          
          # Check if diff is empty
          if [ ! -s pr_diff.txt ]; then
            echo "No changes detected in the PR"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            # Limit diff size to prevent API issues (max ~30KB)
            head -c 30000 pr_diff.txt > pr_diff_truncated.txt
            mv pr_diff_truncated.txt pr_diff.txt
          fi
      
      - name: Create review script
        if: steps.get-diff.outputs.has_changes == 'true'
        run: |
          cat > review.py << 'EOF'
          import os
          import sys
          import json
          import requests
          import time
          
          def get_ai_review(diff_content):
              api_key = os.environ.get('GEMINI_API_KEY')
              if not api_key:
                  raise ValueError("GEMINI_API_KEY is not set")
              
              prompt = """ã‚ãªãŸã¯ã€ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§æŽ¡ç”¨ã•ã‚Œã¦ã„ã‚‹ä»¥ä¸‹ã®æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ã«ç²¾é€šã—ãŸã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¢ã§ã™ã€‚
          - Python: uvã«ã‚ˆã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†, Ruffã«ã‚ˆã‚‹ãƒªãƒ³ãƒ†ã‚£ãƒ³ã‚°, Blackã«ã‚ˆã‚‹ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ
          - JavaScript/TypeScript: Bunã«ã‚ˆã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†, ESLint (Flat Config)ã«ã‚ˆã‚‹ãƒªãƒ³ãƒ†ã‚£ãƒ³ã‚°, Prettierã«ã‚ˆã‚‹ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ, React
          
          ã“ã‚Œã‚‰ã®ãƒ«ãƒ¼ãƒ«ã«åŸºã¥ãã€ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰å¤‰æ›´ï¼ˆdiffå½¢å¼ï¼‰ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚
          ç‰¹ã«ã€ä»¥ä¸‹ã®ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã«æ³¨ç›®ã—ã€å…·ä½“çš„ã§å»ºè¨­çš„ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’æ—¥æœ¬èªžã§æä¾›ã—ã¦ãã ã•ã„ã€‚
          
          --- ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ ---
          1.  **Python (`backend/`):**
              - `pyproject.toml` ã«å®šç¾©ã•ã‚ŒãŸRuffã¨Blackã®ãƒ«ãƒ¼ãƒ«ã«æº–æ‹ ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ
              - æ–°ã—ã„ä¾å­˜é–¢ä¿‚ã¯é©åˆ‡ã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿ
          2.  **JavaScript/TypeScript (`frontend/`):**
              - `eslint.config.js` (Flat Config) ã¨Prettierã®ãƒ«ãƒ¼ãƒ«ã«æº–æ‹ ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ
              - Bunã®åˆ©ç”¨æ–¹æ³•ï¼ˆ`package.json`ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆãªã©ï¼‰ã«å•é¡Œã¯ã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿ
          3.  **å…¨ä½“:**
              - ã‚³ãƒ¼ãƒ‰ã®å“è³ªã€æ½œåœ¨çš„ãªãƒã‚°ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€å¯èª­æ€§ã®è¦³ç‚¹ã§æ”¹å–„ç‚¹ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
          
          ã‚‚ã—å•é¡ŒãŒãªã‘ã‚Œã°ã€ã€ŒæŒ‡æ‘˜äº‹é …ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ç´ æ™´ã‚‰ã—ã„å¤‰æ›´ã§ã™ï¼ã€ã¨ç°¡æ½”ã«è¿°ã¹ã¦ãã ã•ã„ã€‚
          
          --- ã‚³ãƒ¼ãƒ‰å·®åˆ† ---
          {}""".format(diff_content)
              
              # Gemini API endpoint
              url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key={api_key}"
              
              payload = {
                  "contents": [{
                      "parts": [{
                          "text": prompt
                      }]
                  }],
                  "generationConfig": {
                      "temperature": 0.7,
                      "topK": 40,
                      "topP": 0.95,
                      "maxOutputTokens": 2048,
                  }
              }
              
              try:
                  response = requests.post(url, json=payload, timeout=30)
                  response.raise_for_status()
                  
                  result = response.json()
                  if 'candidates' in result and result['candidates']:
                      content = result['candidates'][0].get('content', {})
                      parts = content.get('parts', [])
                      if parts:
                          return parts[0].get('text', 'ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæžœã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚')
                  
                  return "APIã‹ã‚‰ã®å¿œç­”ãŒäºˆæœŸã—ãªã„å½¢å¼ã§ã—ãŸã€‚"
                  
              except requests.exceptions.Timeout:
                  return "â±ï¸ APIãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚å¾Œã»ã©å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚"
              except requests.exceptions.RequestException as e:
                  return f"âŒ APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: {str(e)}"
              except Exception as e:
                  return f"âŒ äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼: {str(e)}"
          
          def post_pr_comment(review_text):
              github_token = os.environ.get('GITHUB_TOKEN')
              if not github_token:
                  raise ValueError("GITHUB_TOKEN is not set")
              
              # Get PR information from environment
              repo = os.environ.get('GITHUB_REPOSITORY')
              pr_number = os.environ.get('PR_NUMBER')
              
              if not repo or not pr_number:
                  raise ValueError("Repository or PR number not found")
              
              # GitHub API endpoint
              url = f"https://api.github.com/repos/{repo}/issues/{pr_number}/comments"
              
              headers = {
                  "Authorization": f"token {github_token}",
                  "Accept": "application/vnd.github.v3+json"
              }
              
              comment_body = f"""## ðŸ¤– AI ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæžœ
          
          {review_text}
          
          ---
          *ã“ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯ Gemini AI ã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚*
          """
              
              payload = {"body": comment_body}
              
              response = requests.post(url, json=payload, headers=headers)
              response.raise_for_status()
              
              return response.json()
          
          def main():
              # Read the diff file
              try:
                  with open('pr_diff.txt', 'r', encoding='utf-8') as f:
                      diff_content = f.read()
              except Exception as e:
                  print(f"Error reading diff file: {e}")
                  sys.exit(1)
              
              if not diff_content.strip():
                  print("No changes to review")
                  sys.exit(0)
              
              # Get AI review
              print("Getting AI review...")
              review = get_ai_review(diff_content)
              
              # Post comment to PR
              print("Posting review comment...")
              try:
                  post_pr_comment(review)
                  print("Review posted successfully!")
              except Exception as e:
                  print(f"Error posting comment: {e}")
                  sys.exit(1)
          
          if __name__ == "__main__":
              main()
          EOF
      
      - name: Run AI review
        if: steps.get-diff.outputs.has_changes == 'true'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          python review.py