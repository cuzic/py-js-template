# å“è³ªåˆ†æå°‚ç”¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# Option Bå®Œå…¨åˆ†é›¢æˆ¦ç•¥: è©³ç´°åˆ†æãƒ»ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå°‚ç”¨

name: Quality Analysis

on:
  schedule:
    # æ¯é€±æœˆæ›œæ—¥ã®åˆå‰2æ™‚ã«å®Ÿè¡Œï¼ˆé€±æ¬¡å“è³ªåˆ†æï¼‰
    - cron: '0 2 * * 1'
  workflow_dispatch:
    inputs:
      analysis_depth:
        description: 'åˆ†ææ·±åº¦ãƒ¬ãƒ™ãƒ«'
        required: false
        default: 'standard'
        type: choice
        options:
        - 'standard'
        - 'comprehensive'
        - 'minimal'
      target_scope:
        description: 'åˆ†æå¯¾è±¡ç¯„å›²'
        required: false
        default: 'both'
        type: choice
        options:
        - 'both'
        - 'python-only'
        - 'javascript-only'

env:
  FORCE_COLOR: 1

permissions:
  contents: read
  pull-requests: write
  actions: read

jobs:
  # === Pythonå“è³ªåˆ†æ ===
  python-quality-analysis:
    name: "ğŸ Pythonå“è³ªåˆ†æ"
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    if: github.event_name == 'schedule' || github.event.inputs.target_scope == 'both' || github.event.inputs.target_scope == 'python-only'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å±¥æ­´åˆ†æã®ãŸã‚å…¨å±¥æ­´å–å¾—

      - name: Setup mise
        uses: jdx/mise-action@v2
        with:
          version: 2025.6.8
          install: true
          cache: true

      - name: Install Python dependencies
        run: |
          cd backend
          uv sync --all-extras

      - name: Comprehensive Python analysis
        run: |
          cd backend
          mkdir -p quality-reports
          
          echo "ğŸ” è©³ç´°Ruffåˆ†æ..."
          uv run ruff check . --output-format=json > quality-reports/ruff-detailed.json || true
          uv run ruff check . --statistics > quality-reports/ruff-stats.txt || true
          
          echo "ğŸ¯ MyPyè©³ç´°åˆ†æ..."
          uv run mypy src --html-report quality-reports/mypy-html || true
          uv run mypy src --txt-report quality-reports/mypy-txt || true
          uv run mypy src --json-report quality-reports/mypy-report.json || true
          
          echo "ğŸ›¡ï¸ Banditè©³ç´°ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æ..."
          uv run bandit -r src/ -f json -o quality-reports/bandit-report.json || true
          uv run bandit -r src/ -f html -o quality-reports/bandit-report.html || true
          
          echo "ğŸ“Š ã‚³ãƒ¼ãƒ‰è¤‡é›‘åº¦åˆ†æ..."
          uv run radon cc src/ --json > quality-reports/complexity.json || true
          uv run radon mi src/ --json > quality-reports/maintainability.json || true
          
          echo "ğŸ“ˆ ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸è©³ç´°åˆ†æ..."
          uv run pytest --cov=backend --cov-report=html:quality-reports/coverage-html --cov-report=json:quality-reports/coverage.json --cov-report=xml:quality-reports/coverage.xml -q || true
          
          echo "ğŸ”’ ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³..."
          uvx pip-audit --format=json --output=quality-reports/security-audit.json || true
          uvx safety check --json --output quality-reports/safety-check.json || true

      - name: Generate Python quality summary
        run: |
          cd backend
          python3 ../scripts/analyze-python-quality.py

      - name: Upload Python quality reports
        uses: actions/upload-artifact@v4
        with:
          name: python-quality-reports
          path: backend/quality-reports/
          retention-days: 30

  # === JavaScriptå“è³ªåˆ†æ ===
  javascript-quality-analysis:
    name: "ğŸ“œ JavaScriptå“è³ªåˆ†æ"
    runs-on: ubuntu-24.04
    timeout-minutes: 8
    if: github.event_name == 'schedule' || github.event.inputs.target_scope == 'both' || github.event.inputs.target_scope == 'javascript-only'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup mise
        uses: jdx/mise-action@v2
        with:
          version: 2025.6.8
          install: true
          cache: true

      - name: Install JavaScript dependencies
        run: |
          cd frontend
          bun install --frozen-lockfile

      - name: Comprehensive JavaScript analysis
        run: |
          cd frontend
          mkdir -p quality-reports
          
          echo "ğŸ” è©³ç´°ESLintåˆ†æ..."
          bun exec eslint . --format=json --output-file=quality-reports/eslint-detailed.json || true
          bun exec eslint . --format=html --output-file=quality-reports/eslint-report.html || true
          
          echo "ğŸ¯ TypeScriptè©³ç´°åˆ†æ..."
          bun run typecheck --pretty false > quality-reports/typescript-detailed.txt 2>&1 || true
          
          echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚åˆ†æ..."
          bun audit --format=json > quality-reports/dependency-audit.json 2>&1 || true
          
          echo "âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ..."
          bun run build
          
          # ãƒãƒ³ãƒ‰ãƒ«åˆ†æ
          ls -la dist/assets/ > quality-reports/bundle-files.txt || true
          du -h dist/assets/* > quality-reports/bundle-sizes.txt 2>/dev/null || true
          
          # Webpack/Viteãƒãƒ³ãƒ‰ãƒ«åˆ†æï¼ˆã‚‚ã—åˆ©ç”¨å¯èƒ½ãªã‚‰ï¼‰
          if [ -f "dist/stats.json" ]; then
            cp dist/stats.json quality-reports/
          fi
          
          echo "ğŸ§ª ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸è©³ç´°åˆ†æ..."
          bun run test:coverage || true
          
          if [ -d "coverage" ]; then
            cp -r coverage quality-reports/coverage-html/
          fi

      - name: Generate JavaScript quality summary
        run: |
          cd frontend
          node ../scripts/analyze-javascript-quality.js

      - name: Upload JavaScript quality reports
        uses: actions/upload-artifact@v4
        with:
          name: javascript-quality-reports
          path: frontend/quality-reports/
          retention-days: 30

  # === å“è³ªãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ ===
  quality-trend-analysis:
    name: "ğŸ“ˆ å“è³ªãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ"
    runs-on: ubuntu-24.04
    needs: [python-quality-analysis, javascript-quality-analysis]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download quality reports
        uses: actions/download-artifact@v4
        with:
          pattern: "*-quality-reports"
          merge-multiple: true
          path: quality-reports/

      - name: Generate comprehensive quality dashboard
        run: |
          # å“è³ªãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
          chmod +x scripts/quality-dashboard.sh
          ./scripts/quality-dashboard.sh 30

      - name: Create quality summary comment
        if: false  # æ‰‹å‹•å®Ÿè¡Œæ™‚ã¯ã‚³ãƒ¡ãƒ³ãƒˆä¸è¦
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let summary = '# ğŸ“Š å“è³ªåˆ†æãƒ¬ãƒãƒ¼ãƒˆ\n\n';
            
            try {
              // Pythonå“è³ªã‚µãƒãƒªãƒ¼
              const pythonSummary = JSON.parse(fs.readFileSync('quality-reports/python-summary.json', 'utf8'));
              summary += `## ğŸ Pythonå“è³ª\n`;
              summary += `- Ruffé•å: ${pythonSummary.ruff_violations}ä»¶\n`;
              summary += `- MyPy ã‚¨ãƒ©ãƒ¼: ${pythonSummary.mypy_errors}ä»¶\n`;
              summary += `- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œ: ${pythonSummary.bandit_issues}ä»¶\n`;
              summary += `- ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸: ${pythonSummary.test_coverage}%\n\n`;
            } catch (e) {
              summary += '## ğŸ Pythonå“è³ª\nãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼\n\n';
            }
            
            try {
              // JavaScriptå“è³ªã‚µãƒãƒªãƒ¼
              const jsSummary = JSON.parse(fs.readFileSync('quality-reports/javascript-summary.json', 'utf8'));
              summary += `## ğŸ“œ JavaScriptå“è³ª\n`;
              summary += `- ESLint ã‚¨ãƒ©ãƒ¼: ${jsSummary.eslint_errors}ä»¶\n`;
              summary += `- ESLint è­¦å‘Š: ${jsSummary.eslint_warnings}ä»¶\n`;
              summary += `- TypeScript ã‚¨ãƒ©ãƒ¼: ${jsSummary.typescript_errors}ä»¶\n`;
              summary += `- ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚º: ${jsSummary.bundle_size_kb}KB\n`;
              summary += `- ä¾å­˜é–¢ä¿‚è„†å¼±æ€§: ${jsSummary.dependency_vulnerabilities}ä»¶\n\n`;
            } catch (e) {
              summary += '## ğŸ“œ JavaScriptå“è³ª\nãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼\n\n';
            }
            
            summary += '## ğŸ“‹ è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ\n';
            summary += 'GitHub Actionsã®ã€ŒSummaryã€ã‚¿ãƒ–ã‹ã‚‰è©³ç´°ãªãƒ¬ãƒãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚\n\n';
            summary += '---\n*ã“ã®åˆ†æã¯å“è³ªå°‚ç”¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

      - name: Upload combined quality dashboard
        uses: actions/upload-artifact@v4
        with:
          name: quality-dashboard
          path: quality-metrics/
          retention-days: 90