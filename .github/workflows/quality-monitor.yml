# å“è³ªç›£è¦–å°‚ç”¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# Option Bå®Œå…¨åˆ†é›¢æˆ¦ç•¥: ã‚¢ãƒ©ãƒ¼ãƒˆãƒ»Issueä½œæˆãƒ»ç›£è¦–å°‚ç”¨

name: Quality Monitor

on:
  schedule:
    # æ¯é€±æ—¥æ›œæ—¥ã®åˆå‰9æ™‚ã«å®Ÿè¡Œï¼ˆé€±æ¬¡ç›£è¦–ãƒ¬ãƒãƒ¼ãƒˆï¼‰
    - cron: '0 9 * * 0'
  workflow_dispatch:
    inputs:
      monitor_type:
        description: 'ç›£è¦–ã‚¿ã‚¤ãƒ—'
        required: false
        default: 'standard'
        type: choice
        options:
        - 'standard'
        - 'bypass-analysis'
        - 'trend-analysis'
        - 'ci-failure-check'
      days_to_analyze:
        description: 'åˆ†æå¯¾è±¡æ—¥æ•°'
        required: false
        default: '7'
        type: string

env:
  FORCE_COLOR: 1

permissions:
  contents: read
  issues: write
  pull-requests: write
  actions: read

jobs:
  # === CIå¤±æ•—ç›£è¦– ===
  ci-failure-monitor:
    name: "ğŸš¨ CIå¤±æ•—ç›£è¦–"
    runs-on: ubuntu-24.04
    if: github.event_name == 'schedule' || github.event.inputs.monitor_type == 'ci-failure-check' || github.event.inputs.monitor_type == 'standard'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get recent CI failures
        id: workflow-details
        uses: actions/github-script@v7
        with:
          script: |
            const daysToCheck = parseInt('${{ github.event.inputs.days_to_analyze || "7" }}');
            const sinceDate = new Date(Date.now() - daysToCheck * 24 * 60 * 60 * 1000).toISOString();
            
            // æœ€è¿‘ã®å¤±æ•—ã—ãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œã‚’å–å¾—
            const workflows = ['Python CI (Improved)', 'JavaScript CI (Improved)'];
            const failures = [];
            
            for (const workflowName of workflows) {
              try {
                const workflowRuns = await github.rest.actions.listWorkflowRuns({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  workflow_id: `${workflowName.toLowerCase().replace(/[^a-z0-9]/g, '-')}.yml`,
                  status: 'failure',
                  created: `>=${sinceDate}`,
                  per_page: 10
                });
                
                for (const run of workflowRuns.data.workflow_runs) {
                  failures.push({
                    workflowName: run.name,
                    conclusion: run.conclusion,
                    htmlUrl: run.html_url,
                    headSha: run.head_sha,
                    runNumber: run.run_number,
                    createdAt: run.created_at
                  });
                }
              } catch (error) {
                console.log(`Could not fetch ${workflowName} runs:`, error.message);
              }
            }
            
            return {
              failureCount: failures.length,
              failures: failures.slice(0, 5)  // æœ€æ–°5ä»¶ã¾ã§
            };

      - name: Generate CI failure summary
        id: failure-analysis
        run: |
          FAILURE_COUNT="${{ fromJson(steps.workflow-details.outputs.result).failureCount }}"
          
          echo "failure_count=$FAILURE_COUNT" >> $GITHUB_OUTPUT
          
          if [ "$FAILURE_COUNT" -gt 0 ]; then
            echo "has_failures=true" >> $GITHUB_OUTPUT
            echo "failure_category=CIå¤±æ•—æ¤œå‡º" >> $GITHUB_OUTPUT
          else
            echo "has_failures=false" >> $GITHUB_OUTPUT
            echo "failure_category=CIæ­£å¸¸" >> $GITHUB_OUTPUT
          fi

      - name: Create CI failure report issue
        if: steps.failure-analysis.outputs.has_failures == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const failureData = ${{ steps.workflow-details.outputs.result }};
            const daysAnalyzed = '${{ github.event.inputs.days_to_analyze || "7" }}';
            
            let failureList = '';
            if (failureData.failures && failureData.failures.length > 0) {
              failureList = failureData.failures.map(failure => 
                `- **${failure.workflowName}** (#${failure.runNumber}): [è©³ç´°](${failure.htmlUrl}) - ${new Date(failure.createdAt).toLocaleDateString('ja-JP')}`
              ).join('\n');
            }
            
            const issueBody = `# ğŸš¨ CIå¤±æ•—ãƒ¬ãƒãƒ¼ãƒˆ

## ğŸ“Š å¤±æ•—çµ±è¨ˆ
- **å¯¾è±¡æœŸé–“**: éå»${daysAnalyzed}æ—¥é–“
- **å¤±æ•—å›æ•°**: ${failureData.failureCount}ä»¶
- **åˆ†æå®Ÿè¡Œæ—¥æ™‚**: ${new Date().toLocaleString('ja-JP')}

## ğŸ“‹ æœ€è¿‘ã®å¤±æ•—ä¸€è¦§
${failureList || 'è©³ç´°æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ'}

## ğŸ“ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
- [ ] å„å¤±æ•—ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®è©³ç´°ãƒ­ã‚°ã‚’ç¢ºèª
- [ ] å…±é€šã™ã‚‹å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³ã®åˆ†æ
- [ ] å¿…è¦ã«å¿œã˜ã¦ä¿®æ­£PRã®ä½œæˆ

## ğŸ”§ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
1. å¤±æ•—ã—ãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ãƒ­ã‚°ã‚’è©³ç´°ç¢ºèª
2. å•é¡Œã®æ ¹æœ¬åŸå› ã‚’ç‰¹å®š
3. é©åˆ‡ãªä¿®æ­£ã‚’å®Ÿæ–½

---
*ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã¯é€±æ¬¡è‡ªå‹•ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã£ã¦ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*`;

            const { data: issue } = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš¨ CIå¤±æ•—ãƒ¬ãƒãƒ¼ãƒˆ (${failureData.failureCount}ä»¶æ¤œå‡º)`,
              body: issueBody,
              labels: ['ci-failure', 'automated', 'investigation-needed']
            });

            console.log('Created CI failure report issue:', issue.number);

  # === ãƒã‚¤ãƒ‘ã‚¹ä½¿ç”¨ç›£è¦– ===
  bypass-monitor:
    name: "ğŸ” ãƒã‚¤ãƒ‘ã‚¹ä½¿ç”¨ç›£è¦–"
    runs-on: ubuntu-24.04
    if: github.event_name == 'schedule' || github.event.inputs.monitor_type == 'bypass-analysis' || github.event.inputs.monitor_type == 'standard'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å±¥æ­´åˆ†æã®ãŸã‚å…¨å±¥æ­´å¿…è¦

      - name: Run bypass usage analysis
        run: |
          chmod +x scripts/monitor-bypass-usage.sh
          ./scripts/monitor-bypass-usage.sh ${{ github.event.inputs.days_to_analyze || '7' }}

      - name: Check bypass usage threshold
        id: bypass-check
        run: |
          # ãƒã‚¤ãƒ‘ã‚¹ä½¿ç”¨ãƒ¬ãƒãƒ¼ãƒˆã‚’è§£æ
          if [ -f "bypass-usage.log" ]; then
            # é–¾å€¤è¶…éãƒã‚§ãƒƒã‚¯ï¼ˆä¾‹: é€±10å›ä»¥ä¸Šã®ãƒã‚¤ãƒ‘ã‚¹ä½¿ç”¨ï¼‰
            BYPASS_COUNT=$(grep -o "ç–‘ã‚ã—ã„ã‚³ãƒŸãƒƒãƒˆ" bypass-usage.log | wc -l || echo "0")
            
            if [ "$BYPASS_COUNT" -gt 10 ]; then
              echo "threshold_exceeded=true" >> $GITHUB_OUTPUT
              echo "bypass_count=$BYPASS_COUNT" >> $GITHUB_OUTPUT
            else
              echo "threshold_exceeded=false" >> $GITHUB_OUTPUT
              echo "bypass_count=$BYPASS_COUNT" >> $GITHUB_OUTPUT
            fi
          else
            echo "threshold_exceeded=false" >> $GITHUB_OUTPUT
            echo "bypass_count=0" >> $GITHUB_OUTPUT
          fi

      - name: Create bypass alert issue
        if: steps.bypass-check.outputs.threshold_exceeded == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const bypassCount = '${{ steps.bypass-check.outputs.bypass_count }}';
            
            const issueBody = `# ğŸš¨ Pre-commit ãƒã‚¤ãƒ‘ã‚¹ä½¿ç”¨ã‚¢ãƒ©ãƒ¼ãƒˆ

## ğŸ“Š æ¤œå‡ºçŠ¶æ³
- **éå»7æ—¥é–“ã®ãƒã‚¤ãƒ‘ã‚¹ä½¿ç”¨å›æ•°**: ${bypassCount}å›
- **è­¦å‘Šé–¾å€¤**: 10å›
- **æ¤œå‡ºæ—¥æ™‚**: ${new Date().toLocaleString('ja-JP')}

## ğŸ” èª¿æŸ»ãŒå¿…è¦ãªé …ç›®
- [ ] å€‹åˆ¥é–‹ç™ºè€…ã®ãƒã‚¤ãƒ‘ã‚¹ä½¿ç”¨çŠ¶æ³ç¢ºèª
- [ ] pre-commitãƒ•ãƒƒã‚¯ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å•é¡Œèª¿æŸ»
- [ ] ãƒãƒ¼ãƒ æ•™è‚²ã®å¿…è¦æ€§è©•ä¾¡

## ğŸ“‹ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
1. **å³åº§å®Ÿè¡Œ**: ãƒã‚¤ãƒ‘ã‚¹ä½¿ç”¨çŠ¶æ³ã®å€‹åˆ¥ãƒ’ã‚¢ãƒªãƒ³ã‚°
2. **çŸ­æœŸå¯¾å¿œ**: pre-commitãƒ•ãƒƒã‚¯è»½é‡åŒ–ã®æ¤œè¨
3. **ä¸­æœŸå¯¾å¿œ**: ãƒãƒ¼ãƒ æ•™è‚²ãƒ»ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³è¦‹ç›´ã—

## ğŸ“„ è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ
è©³ç´°ãªåˆ†æçµæœã¯ GitHub Actions ã®ã€Œbypass-monitorã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œãƒ­ã‚°ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

---
*ã“ã®è­¦å‘Šã¯è‡ªå‹•ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã£ã¦ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*`;

            const { data: issue } = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ Pre-commit ãƒã‚¤ãƒ‘ã‚¹ä½¿ç”¨è­¦å‘Šï¼ˆé–¾å€¤è¶…éï¼‰',
              body: issueBody,
              labels: ['quality-warning', 'automated', 'high-priority']
            });

            console.log('Created bypass alert issue:', issue.number);

      - name: Upload bypass analysis report
        uses: actions/upload-artifact@v4
        with:
          name: bypass-analysis-report
          path: bypass-usage.log
          retention-days: 30

  # === å“è³ªãƒˆãƒ¬ãƒ³ãƒ‰ç›£è¦– ===
  quality-trend-monitor:
    name: "ğŸ“ˆ å“è³ªãƒˆãƒ¬ãƒ³ãƒ‰ç›£è¦–"
    runs-on: ubuntu-24.04
    if: github.event_name == 'schedule' || github.event.inputs.monitor_type == 'trend-analysis' || github.event.inputs.monitor_type == 'standard'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate quality metrics
        run: |
          chmod +x scripts/quality-dashboard.sh
          ./scripts/quality-dashboard.sh ${{ github.event.inputs.days_to_analyze || '30' }}

      - name: Analyze quality trends
        id: trend-analysis
        run: |
          # å“è³ªãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æï¼ˆç°¡æ˜“ç‰ˆï¼‰
          # å®Ÿéš›ã®å®Ÿè£…ã§ã¯éå»ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã¨æ¯”è¼ƒ
          
          CURRENT_DATE=$(date +%Y-%m-%d)
          
          # æ¨¡æ“¬çš„ãªå“è³ªåŠ£åŒ–æ¤œå‡º
          QUALITY_DEGRADED=false
          DEGRADATION_REASON=""
          
          # ã‚«ãƒãƒ¬ãƒƒã‚¸ä½ä¸‹ãƒã‚§ãƒƒã‚¯ï¼ˆä¾‹ï¼‰
          if [ -f "quality-metrics/git-metrics.json" ]; then
            # å®Ÿéš›ã«ã¯éå»ãƒ‡ãƒ¼ã‚¿ã¨ã®æ¯”è¼ƒã‚’å®Ÿè£…
            echo "quality_degraded=false" >> $GITHUB_OUTPUT
            echo "degradation_reason=å“è³ªç¶­æŒ" >> $GITHUB_OUTPUT
          else
            echo "quality_degraded=false" >> $GITHUB_OUTPUT
            echo "degradation_reason=ãƒ‡ãƒ¼ã‚¿ä¸è¶³" >> $GITHUB_OUTPUT
          fi

      - name: Create quality trend report issue
        uses: actions/github-script@v7
        with:
          script: |
            const qualityDegraded = '${{ steps.trend-analysis.outputs.quality_degraded }}';
            const degradationReason = '${{ steps.trend-analysis.outputs.degradation_reason }}';
            
            const daysToAnalyze = '${{ github.event.inputs.days_to_analyze || "30" }}';
            const startDate = new Date(Date.now() - parseInt(daysToAnalyze)*24*60*60*1000);
            
            const reportBody = `# ğŸ“Š å“è³ªç›£è¦–ãƒ¬ãƒãƒ¼ãƒˆ

## ğŸ“… ãƒ¬ãƒãƒ¼ãƒˆæœŸé–“
**å¯¾è±¡æœŸé–“**: ${startDate.toLocaleDateString('ja-JP')} ï½ ${new Date().toLocaleDateString('ja-JP')} (${daysToAnalyze}æ—¥é–“)

## ğŸ¯ å“è³ªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
- **å…¨ä½“è©•ä¾¡**: ${qualityDegraded === 'true' ? 'âš ï¸ æ³¨æ„ãŒå¿…è¦' : 'âœ… è‰¯å¥½'}
- **ä¸»ãªçŠ¶æ³**: ${degradationReason}

## ğŸ“ˆ ä¸»è¦ãƒ¡ãƒˆãƒªã‚¯ã‚¹
- **pre-commitå®Ÿè¡Œæ™‚é–“**: ç›®æ¨™3ç§’ä»¥å†…
- **CIæˆåŠŸç‡**: ç›®æ¨™95%ä»¥ä¸Š
- **ã‚«ãƒãƒ¬ãƒƒã‚¸**: ç›®æ¨™80%ä»¥ä¸Š
- **ãƒã‚¤ãƒ‘ã‚¹ä½¿ç”¨**: ç›®æ¨™1å›/æœˆæœªæº€

## ğŸ¯ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é …ç›®
- [ ] å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®ç¶™ç¶šç›£è¦–
- [ ] pre-commitãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç¢ºèª
- [ ] ãƒãƒ¼ãƒ å“è³ªæ„è­˜ã®è©•ä¾¡

## ğŸ“Š è©³ç´°ãƒ‡ãƒ¼ã‚¿
è©³ç´°ãªå“è³ªãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¯ GitHub Actions ã®ã€Œquality-trend-monitorã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œçµæœã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

---
*ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã¯é€±æ¬¡è‡ªå‹•ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã£ã¦ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*`;

            const { data: issue } = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸ“Š å“è³ªç›£è¦–ãƒ¬ãƒãƒ¼ãƒˆ',
              body: reportBody,
              labels: ['quality-report', 'automated', 'weekly']
            });

            console.log('Created quality trend report:', issue.number);

      - name: Upload quality trend report
        uses: actions/upload-artifact@v4
        with:
          name: quality-trend-report
          path: quality-metrics/
          retention-days: 90

  # === ã‚¢ãƒ©ãƒ¼ãƒˆçµ±åˆ ===
  alert-consolidation:
    name: "ğŸ“¢ ã‚¢ãƒ©ãƒ¼ãƒˆçµ±åˆ"
    runs-on: ubuntu-24.04
    needs: [ci-failure-monitor, bypass-monitor, quality-trend-monitor]
    if: always() && (needs.ci-failure-monitor.result == 'success' || needs.bypass-monitor.result == 'success' || needs.quality-trend-monitor.result == 'success')
    steps:
      - name: Send consolidated alert
        if: contains(needs.*.result, 'success')
        run: |
          echo "ğŸ“¢ å“è³ªç›£è¦–ã‚¢ãƒ©ãƒ¼ãƒˆçµ±åˆå®Œäº†"
          echo "å®Ÿè¡Œã•ã‚ŒãŸç›£è¦–:"
          echo "- CIå¤±æ•—ç›£è¦–: ${{ needs.ci-failure-monitor.result }}"
          echo "- ãƒã‚¤ãƒ‘ã‚¹ç›£è¦–: ${{ needs.bypass-monitor.result }}"
          echo "- ãƒˆãƒ¬ãƒ³ãƒ‰ç›£è¦–: ${{ needs.quality-trend-monitor.result }}"
          
          # å°†æ¥çš„ã«Slackã€Teamsã€ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ãªã©ã‚’å®Ÿè£…
          # if [ -n "${SLACK_WEBHOOK_URL:-}" ]; then
          #   curl -X POST -H 'Content-type: application/json' \
          #     --data '{"text":"ğŸ“Š å“è³ªç›£è¦–ãƒ¬ãƒãƒ¼ãƒˆãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ"}' \
          #     "$SLACK_WEBHOOK_URL"
          # fi